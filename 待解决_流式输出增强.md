# æµå¼è¾“å‡ºå¢å¼º - æ— æ°´å°åœ°å€å’ŒGoogle Driveåœ°å€

## é—®é¢˜

ç”¨æˆ·è¯¢é—®ï¼šæµå¼è¾“å‡ºäº†æ— æ°´å°åœ°å€å—ï¼Ÿè¾“å‡ºGoogle Driveçš„è§†é¢‘åœ°å€äº†å—ï¼Ÿ

## åˆ†æç»“æœ

### âœ… **åŸæœ‰æµå¼è¾“å‡º**

ç³»ç»Ÿ**å·²ç»å®ç°**äº†å®Œæ•´çš„æµå¼è¾“å‡ºï¼ŒåŒ…æ‹¬ï¼š

1. **æ— æ°´å°å¤„ç†æµç¨‹**
   - âœ… å¼€å§‹ç­‰å¾…æ— æ°´å°è¾“å‡º
   - âœ… è§†é¢‘å‘å¸ƒæˆåŠŸï¼ˆåŒ…å«post_idï¼‰
   - âœ… ç­‰å¾…æ–‡ä»¶å°±ç»ªï¼ˆåŒ…å«é‡è¯•æ¬¡æ•°ï¼‰
   - âœ… åˆ‡æ¢å¤‡ç”¨URL
   - âœ… æ–‡ä»¶å°±ç»ªç¡®è®¤

2. **Google Driveä¸Šä¼ æµç¨‹**
   - âœ… å¼€å§‹ä¸Šä¼ æç¤º
   - âœ… ä¸Šä¼ æˆåŠŸ/å¤±è´¥æç¤º
   - âœ… å¼‚å¸¸å¤„ç†å’Œå›é€€

3. **æœ€ç»ˆURLè¾“å‡º**
   - âœ… åœ¨`extra.output`ä¸­åŒ…å«æœ€ç»ˆè§†é¢‘URL

### âš ï¸ **åŸæœ‰é—®é¢˜**

è™½ç„¶æœ‰æµå¼è¾“å‡ºï¼Œä½†å­˜åœ¨ä»¥ä¸‹ä¸è¶³ï¼š

1. **æ— æ°´å°URLä¸å¤Ÿæ˜æ˜¾**
   - æ— æ°´å°URLè·å–æˆåŠŸåï¼Œåªæç¤º"æ–‡ä»¶å°±ç»ª"
   - æ²¡æœ‰æ˜ç¡®æ˜¾ç¤ºæ— æ°´å°URLåœ°å€

2. **Google Drive URLä¸å¤Ÿæ˜æ˜¾**
   - ä¸Šä¼ æˆåŠŸååªæ˜¾ç¤º"âœ… ä¸Šä¼ æˆåŠŸ"
   - æ²¡æœ‰æ˜ç¡®æ˜¾ç¤ºGoogle Driveçš„å…·ä½“URL

## æ”¹è¿›æ–¹æ¡ˆ

### ä¿®æ”¹1ï¼šè¾“å‡ºæ— æ°´å°URLï¼ˆç¬¬1003-1024è¡Œï¼‰

**ä¿®æ”¹å‰**ï¼š
```python
if stream:
    yield self._format_stream_chunk(
        reasoning_content=(
            f"Watermark-free URL is ready (checked {ready_checks} times).\n"
            f"Now {'caching' if config.cache_enabled else 'returning'} watermark-free video...\n"
        ),
        extra={
            "wm": {
                "stage": "ready",
                "attempt": wm_attempt,
                "can_cancel": wm_attempt >= 3,
                "task_id": task_id,
            }
        }
    )
```

**ä¿®æ”¹å**ï¼š
```python
if stream:
    yield self._format_stream_chunk(
        reasoning_content=(
            f"Watermark-free URL is ready (checked {ready_checks} times).\n"
            f"ğŸ“¹ **Watermark-free URL**: {watermark_free_url}\n"  # â† æ–°å¢ï¼šæ˜¾ç¤ºæ— æ°´å°URL
            f"Now {'caching' if config.cache_enabled else 'returning'} watermark-free video...\n"
        ),
        extra={
            "wm": {
                "stage": "ready",
                "attempt": wm_attempt,
                "can_cancel": wm_attempt >= 3,
                "task_id": task_id,
            },
            "output": [{  # â† æ–°å¢ï¼šç»“æ„åŒ–è¾“å‡ºæ— æ°´å°URL
                "url": watermark_free_url,
                "type": "video",
                "task_id": task_id,
                "watermark_free": True,
            }]
        }
    )
```

### ä¿®æ”¹2ï¼šè¾“å‡ºGoogle Drive URLï¼ˆç¬¬1058-1073è¡Œï¼‰

**ä¿®æ”¹å‰**ï¼š
```python
if local_url:
    if stream:
        yield self._format_stream_chunk(
            reasoning_content=f"âœ… Video uploaded to Google Drive successfully!\n"
        )
```

**ä¿®æ”¹å**ï¼š
```python
if local_url:
    if stream:
        yield self._format_stream_chunk(
            reasoning_content=(
                f"âœ… Video uploaded to Google Drive successfully!\n"
                f"ğŸ”— **Google Drive URL**: {local_url}\n"  # â† æ–°å¢ï¼šæ˜¾ç¤ºGoogle Drive URL
            ),
            extra={
                "output": [{  # â† æ–°å¢ï¼šç»“æ„åŒ–è¾“å‡ºGoogle Drive URL
                    "url": local_url,
                    "type": "video",
                    "task_id": task_id,
                    "watermark_free": True,
                    "source": "google_drive"
                }]
            }
        )
```

## æ”¹è¿›æ•ˆæœ

### å®¢æˆ·ç«¯å°†çœ‹åˆ°çš„æµå¼è¾“å‡º

#### åœºæ™¯1ï¼šæ— æ°´å°æ¨¡å¼ + Google Driveä¸Šä¼ 

```
1. **Video Generation Progress**: 9% (running)
2. **Video Generation Progress**: 18% (running)
...
3. **Video Generation Completed**
   Watermark-free mode enabled. Waiting for watermark-free output...

4. Video published successfully. Post ID: p_abc123
   Now caching watermark-free video...

5. Watermark-free file not ready (HTTP 404), waiting... (attempt 1)
6. Watermark-free file not ready (HTTP 404), waiting... (attempt 2)
...

7. Watermark-free URL is ready (checked 5 times).
   ğŸ“¹ **Watermark-free URL**: https://oscdn2.dyysy.com/MP4/p_abc123.mp4
   Now caching watermark-free video...

8. Uploading watermark-free video to Google Drive...

9. âœ… Video uploaded to Google Drive successfully!
   ğŸ”— **Google Drive URL**: https://drive.google.com/file/d/1abc.../view

10. <video src='https://drive.google.com/file/d/1abc.../view' controls></video>
```

#### åœºæ™¯2ï¼šæ— æ°´å°æ¨¡å¼ + æœ¬åœ°ç¼“å­˜

```
...
7. Watermark-free URL is ready (checked 5 times).
   ğŸ“¹ **Watermark-free URL**: https://oscdn2.dyysy.com/MP4/p_abc123.mp4
   Now caching watermark-free video...

8. Watermark-free video cached successfully. Preparing final response...

9. <video src='http://localhost:7860/tmp/cached_video_123.mp4' controls></video>
```

#### åœºæ™¯3ï¼šæ— æ°´å°æ¨¡å¼ + ç¼“å­˜ç¦ç”¨

```
...
7. Watermark-free URL is ready (checked 5 times).
   ğŸ“¹ **Watermark-free URL**: https://oscdn2.dyysy.com/MP4/p_abc123.mp4
   Now returning watermark-free video...

8. Cache is disabled. Using watermark-free URL directly...

9. <video src='https://oscdn2.dyysy.com/MP4/p_abc123.mp4' controls></video>
```

## æ•°æ®ç»“æ„

### SSEæµä¸­çš„outputå­—æ®µ

å®¢æˆ·ç«¯ç°åœ¨ä¼šåœ¨å¤šä¸ªé˜¶æ®µæ”¶åˆ°`output`å­—æ®µï¼š

#### 1. æ— æ°´å°URLå°±ç»ªæ—¶
```json
{
  "choices": [{
    "delta": {
      "reasoning_content": "ğŸ“¹ **Watermark-free URL**: https://oscdn2.dyysy.com/...\n",
      "output": [{
        "url": "https://oscdn2.dyysy.com/MP4/p_abc123.mp4",
        "type": "video",
        "task_id": "task_123",
        "watermark_free": true
      }]
    }
  }]
}
```

#### 2. Google Driveä¸Šä¼ æˆåŠŸæ—¶
```json
{
  "choices": [{
    "delta": {
      "reasoning_content": "ğŸ”— **Google Drive URL**: https://drive.google.com/...\n",
      "output": [{
        "url": "https://drive.google.com/file/d/1abc.../view",
        "type": "video",
        "task_id": "task_123",
        "watermark_free": true,
        "source": "google_drive"
      }]
    }
  }]
}
```

#### 3. æœ€ç»ˆå®Œæˆæ—¶
```json
{
  "choices": [{
    "delta": {
      "content": "<video src='...' controls></video>",
      "finish_reason": "STOP",
      "output": [{
        "url": "https://drive.google.com/file/d/1abc.../view",
        "type": "video",
        "task_id": "task_123"
      }]
    }
  }]
}
```

## å‰ç«¯å¤„ç†å»ºè®®

å‰ç«¯`generate.js`å·²ç»å¯ä»¥å¤„ç†è¿™äº›æ›´æ–°ï¼š

1. **æå–URL**ï¼ˆç¬¬2832-2863è¡Œï¼‰
   ```javascript
   const candidates = [
     obj.url,
     obj.video_url && obj.video_url.url,
     obj.image_url && obj.image_url.url,
     output0 && (output0.url || output0.video_url || output0.image_url),
     deltaOut0 && (deltaOut0.url || deltaOut0.video_url || deltaOut0.image_url)
   ].filter(Boolean);
   ```

2. **æ˜¾ç¤ºreasoning_content**
   - å‰ç«¯ä¼šè‡ªåŠ¨æ˜¾ç¤º`reasoning_content`ä¸­çš„å†…å®¹
   - ç”¨æˆ·å¯ä»¥çœ‹åˆ°"ğŸ“¹ **Watermark-free URL**: ..."å’Œ"ğŸ”— **Google Drive URL**: ..."

3. **æ›´æ–°ä»»åŠ¡å¡**
   - URLä¼šè‡ªåŠ¨æ›´æ–°åˆ°ä»»åŠ¡å¡
   - ç”¨æˆ·å¯ä»¥ç‚¹å‡»æŸ¥çœ‹æˆ–ä¸‹è½½

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨æœåŠ¡å™¨**
   ```bash
   python main.py
   ```

2. **é…ç½®æ— æ°´å°æ¨¡å¼**
   - åœ¨ç®¡ç†ç•Œé¢å¯ç”¨"æ— æ°´å°æ¨¡å¼"
   - é…ç½®Google Driveä¸Šä¼ ï¼ˆå¦‚æœéœ€è¦ï¼‰

3. **ç”Ÿæˆè§†é¢‘**
   - è¾“å…¥æç¤ºè¯
   - æäº¤ç”Ÿæˆè¯·æ±‚

4. **è§‚å¯Ÿè¾“å‡º**
   - æŸ¥çœ‹ä»»åŠ¡å¡çš„çŠ¶æ€æ›´æ–°
   - ç¡®è®¤èƒ½çœ‹åˆ°æ— æ°´å°URL
   - ç¡®è®¤èƒ½çœ‹åˆ°Google Drive URLï¼ˆå¦‚æœå¯ç”¨ï¼‰

### é¢„æœŸç»“æœ

- âœ… èƒ½çœ‹åˆ°"ğŸ“¹ **Watermark-free URL**: ..."
- âœ… èƒ½çœ‹åˆ°"ğŸ”— **Google Drive URL**: ..."ï¼ˆå¦‚æœå¯ç”¨Google Driveï¼‰
- âœ… æœ€ç»ˆè§†é¢‘URLæ˜¯æ­£ç¡®çš„ï¼ˆGoogle Driveæˆ–æœ¬åœ°ç¼“å­˜ï¼‰
- âœ… æ‰€æœ‰URLéƒ½å¯ä»¥è®¿é—®å’Œæ’­æ”¾

## æ€»ç»“

### æ”¹è¿›ç‚¹

1. âœ… **æ˜ç¡®æ˜¾ç¤ºæ— æ°´å°URL** - ç”¨æˆ·å¯ä»¥ç›´æ¥çœ‹åˆ°æ— æ°´å°è§†é¢‘åœ°å€
2. âœ… **æ˜ç¡®æ˜¾ç¤ºGoogle Drive URL** - ç”¨æˆ·å¯ä»¥ç›´æ¥çœ‹åˆ°ä¸Šä¼ åçš„åœ°å€
3. âœ… **ç»“æ„åŒ–è¾“å‡º** - åœ¨`extra.output`ä¸­æä¾›URLï¼Œæ–¹ä¾¿å‰ç«¯å¤„ç†
4. âœ… **å‘åå…¼å®¹** - ä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼Œåªæ˜¯å¢å¼ºäº†è¾“å‡ºä¿¡æ¯

### ç›¸å…³æ–‡ä»¶

- âœ… `src/services/generation_handler.py` - å·²ä¿®æ”¹ï¼ˆç¬¬1003-1073è¡Œï¼‰
- ğŸ“„ `static/js/generate.js` - å‰ç«¯å¤„ç†ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

### å›ç­”åŸé—®é¢˜

**Q: æµå¼è¾“å‡ºäº†æ— æ°´å°åœ°å€å—ï¼Ÿ**
- âœ… **æ˜¯çš„**ï¼Œç°åœ¨ä¼šåœ¨æ— æ°´å°URLå°±ç»ªæ—¶æ˜ç¡®è¾“å‡ºï¼š`ğŸ“¹ **Watermark-free URL**: https://oscdn2.dyysy.com/MP4/...`

**Q: è¾“å‡ºGoogle Driveçš„è§†é¢‘åœ°å€äº†å—ï¼Ÿ**
- âœ… **æ˜¯çš„**ï¼Œç°åœ¨ä¼šåœ¨ä¸Šä¼ æˆåŠŸæ—¶æ˜ç¡®è¾“å‡ºï¼š`ğŸ”— **Google Drive URL**: https://drive.google.com/file/d/...`
